<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Diagnostics</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; white-space: pre-wrap; }
        .log { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ðŸ”§ Backend Diagnostics Tool</h1>
    <p>This tool helps diagnose CORS and connectivity issues with your chatbot backend on localhost:8000</p>
    
    <div class="test-section">
        <h3>ðŸŽ¯ **Issue Identified: Browser CORS Caching**</h3>
        <div class="success">
            <p><strong>âœ… Backend is working perfectly!</strong></p>
            <p>The backend has proper CORS configuration and responds correctly to requests when tested with curl.</p>
            <p><strong>The issue is browser-specific CORS caching or security policies.</strong></p>
        </div>
        
        <h4>ðŸ”§ Solutions (try in this order):</h4>
        <ol>
            <li><strong>Hard Refresh:</strong> Press <code>Ctrl+F5</code> (Windows) or <code>Cmd+Shift+R</code> (Mac) to bypass cache</li>
            <li><strong>Incognito Mode:</strong> Open the app in a private/incognito window</li>
            <li><strong>Clear Browser Cache:</strong> Clear cache and cookies for localhost:3000</li>
            <li><strong>Disable Extensions:</strong> Temporarily disable ad blockers and security extensions</li>
            <li><strong>Try Different Browser:</strong> Test in Chrome, Firefox, or Edge</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>Test Results</h3>
        <div id="results"></div>
    </div>
    
    <div class="test-section">
        <h3>Actions</h3>
        <button onclick="testBackendConnectivity()">Test Backend Connectivity</button>
        <button onclick="testCORSPreflight()">Test CORS Preflight</button>
        <button onclick="testScopeConflictQuery()">Test Scope Conflict Query</button>
        <button onclick="testSimpleQuery()">Test Simple Query</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>
    
    <div class="test-section">
        <h3>Expected Backend CORS Configuration</h3>
        <pre id="corsConfig">
# For FastAPI (Python)
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
)

# For Express.js (Node.js)
const cors = require('cors');
app.use(cors({
    origin: 'http://localhost:3000',
    credentials: true
}));

# For Flask (Python)
from flask_cors import CORS
CORS(app, origins=['http://localhost:3000'])
        </pre>
    </div>
    
    <div class="test-section">
        <h3>Console Logs</h3>
        <div id="logs" class="log"></div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8000';
        const results = document.getElementById('results');
        const logs = document.getElementById('logs');
        
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>${timestamp}</strong>: ${message}`;
            logEntry.className = type;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function addResult(title, status, details, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-section ${type}`;
            resultDiv.innerHTML = `
                <h4>${title}</h4>
                <p><strong>Status:</strong> ${status}</p>
                <pre>${details}</pre>
            `;
            results.appendChild(resultDiv);
        }
        
        function clearResults() {
            results.innerHTML = '';
            logs.innerHTML = '';
        }
        
        async function testBackendConnectivity() {
            logMessage('Testing basic backend connectivity...', 'info');
            
            try {
                // Test if backend is responding at all
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(`${BASE_URL}/copilot/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: 'ping' }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const responseText = await response.text();
                
                addResult(
                    'âœ… Backend Connectivity',
                    `${response.status} ${response.statusText}`,
                    `Response Headers:\n${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}\n\nResponse Body (first 500 chars):\n${responseText.substring(0, 500)}`,
                    response.ok ? 'success' : 'warning'
                );
                
                logMessage(`Backend responded with status ${response.status}`, response.ok ? 'success' : 'warning');
                
            } catch (error) {
                addResult(
                    'âŒ Backend Connectivity',
                    'FAILED',
                    `Error: ${error.message}\n\nError Type: ${error.constructor.name}\n\nThis usually means:\n1. Backend is not running on localhost:8000\n2. CORS is blocking the request\n3. Network connectivity issue`,
                    'error'
                );
                
                logMessage(`Backend connectivity failed: ${error.message}`, 'error');
            }
        }
        
        async function testCORSPreflight() {
            logMessage('Testing CORS preflight request...', 'info');
            
            try {
                const response = await fetch(`${BASE_URL}/copilot/`, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type',
                        'Origin': 'http://localhost:3000'
                    }
                });
                
                const corsHeaders = {
                    'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                    'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
                    'access-control-allow-headers': response.headers.get('access-control-allow-headers'),
                    'access-control-max-age': response.headers.get('access-control-max-age')
                };
                
                const isValidCORS = corsHeaders['access-control-allow-origin'] === 'http://localhost:3000' || 
                                   corsHeaders['access-control-allow-origin'] === '*';
                
                addResult(
                    isValidCORS ? 'âœ… CORS Preflight' : 'âš ï¸ CORS Preflight',
                    `${response.status} ${response.statusText}`,
                    `CORS Headers:\n${JSON.stringify(corsHeaders, null, 2)}\n\nValid CORS: ${isValidCORS}`,
                    isValidCORS ? 'success' : 'warning'
                );
                
                logMessage(`CORS preflight: ${response.status}, Valid: ${isValidCORS}`, isValidCORS ? 'success' : 'warning');
                
            } catch (error) {
                addResult(
                    'âŒ CORS Preflight',
                    'FAILED',
                    `Error: ${error.message}\n\nThis suggests CORS is not properly configured on the backend.`,
                    'error'
                );
                
                logMessage(`CORS preflight failed: ${error.message}`, 'error');
            }
        }
        
        async function testScopeConflictQuery() {
            logMessage('Testing scope conflict query (the failing one)...', 'info');
            
            const testContext = {
                page: 'client-details',
                client: { client_id: 'test-client', access_token_lifetime: 120 },
                scopeConflicts: []
            };
            
            try {
                const response = await fetch(`${BASE_URL}/copilot/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: 'Access tokens utlÃ¸per fÃ¸r klientens innstilling',
                        context: testContext
                    })
                });
                
                const responseData = await response.json();
                
                addResult(
                    response.ok ? 'âœ… Scope Conflict Query' : 'âŒ Scope Conflict Query',
                    `${response.status} ${response.statusText}`,
                    `Request Size: ${JSON.stringify({ question: 'Access tokens utlÃ¸per fÃ¸r klientens innstilling', context: testContext }).length} bytes\n\nResponse:\n${JSON.stringify(responseData, null, 2)}`,
                    response.ok ? 'success' : 'error'
                );
                
                logMessage(`Scope conflict query: ${response.status}`, response.ok ? 'success' : 'error');
                
            } catch (error) {
                addResult(
                    'âŒ Scope Conflict Query',
                    'FAILED',
                    `Error: ${error.message}\n\nThis is the exact same query that's failing in your app.`,
                    'error'
                );
                
                logMessage(`Scope conflict query failed: ${error.message}`, 'error');
            }
        }
        
        async function testSimpleQuery() {
            logMessage('Testing simple query (should work)...', 'info');
            
            const testContext = {
                page: 'client-details',
                client: { client_id: 'test-client', scopes: ['openid', 'profile'] }
            };
            
            try {
                const response = await fetch(`${BASE_URL}/copilot/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: 'Hvilke scopes har denne klienten?',
                        context: testContext
                    })
                });
                
                const responseData = await response.json();
                
                addResult(
                    response.ok ? 'âœ… Simple Query' : 'âŒ Simple Query',
                    `${response.status} ${response.statusText}`,
                    `Request Size: ${JSON.stringify({ question: 'Hvilke scopes har denne klienten?', context: testContext }).length} bytes\n\nResponse:\n${JSON.stringify(responseData, null, 2)}`,
                    response.ok ? 'success' : 'error'
                );
                
                logMessage(`Simple query: ${response.status}`, response.ok ? 'success' : 'error');
                
            } catch (error) {
                addResult(
                    'âŒ Simple Query',
                    'FAILED',
                    `Error: ${error.message}`,
                    'error'
                );
                
                logMessage(`Simple query failed: ${error.message}`, 'error');
            }
        }
        
        // Auto-run basic connectivity test on page load
        window.addEventListener('load', () => {
            logMessage('Backend Diagnostics Tool loaded', 'info');
            logMessage('Click "Test Backend Connectivity" to start diagnosing the issue', 'info');
        });
    </script>
</body>
</html>
